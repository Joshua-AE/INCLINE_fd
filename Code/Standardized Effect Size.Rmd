---
title: "Standardized Effect Size"
author: "Joshua"
date: "2023-10-13"
output: html_document
---

# Packages
```{r echo = FALSE, print = FALSE, message = FALSE}
library("tidyverse")
library("ie2misc") # madstat mean absolute deviation
```

# Re-arranging data frame and computing Cohen's d
```{r}
raw_traits <- readr::read_tsv("../Input data/PFTC6_Incline_clean_leaf_traits_2022.txt", guess_max = Inf) # updated version of this file has leaf area and SLA of Avenella flexuosa, Festuca vivipara, Nardus stricta, Festuca ovin and Festuca rubra doubled
chem_traits <- readr::read_tsv("../Input data/PFTC6_Incline_clean_chemical_traits_2022.txt", guess_max = Inf)
chem_traits$merged <- case_when(str_detect(chem_traits$ID_merged, "_") == TRUE ~ "merged") # updates 'merged' column to flag all merged samples
# I checked that only samples were merged from the same site, block and treatment
traits <- raw_traits %>% select(c(siteID, blockID, warming, species, trait, value)) %>% na.omit() %>%
  filter(trait %in% c("ldmc", "leaf_area_cm2", "leaf_thickness_mm", "plant_height_cm", "sla_cm2_g")) # one sample removed: DLL3549

chem_traits <- chem_traits %>% group_by(ID_merged, trait) %>% sample_n(1) # removes all duplicated samples
chem_traits <- chem_traits %>% ungroup() %>% select(c(siteID, blockID, warming, species, trait, value)) %>% na.omit() %>%
  filter(trait %in% c("c_percent", "n_percent", "c_n", "d15n", "d13c")) # no sample removed, but trait phosphorus percentage removed because of missing data

traits <- rbind(traits, chem_traits)
test <- as.data.frame(table(traits$trait))
rm(test, chem_traits, raw_traits)

# aggregated by site, block and experiment____________________________________________________________________________
traits1 <- aggregate(traits$value, by = traits[,1:5], FUN = na.omit(mean))
traits1 <- rename(traits1, mean_value = x)
traits1l <- aggregate(traits$value, by = traits[,1:5], FUN = na.omit(length))
traits1l <- rename(traits1l, n_obs = x)
traits1sd <- aggregate(traits$value, by = traits[,1:5], FUN = na.omit(var)) # defaults to sample variance, not population variance
traits1sd$x <- sqrt(traits1sd$x)
traits1sd <- rename(traits1sd, sd = x)

# aggregated by site and experiment__________________________________________________________________________________
traits2 <- aggregate(traits$value, by = traits[,c(1,3:5)], FUN = na.omit(mean))
traits2 <- rename(traits2, mean_value = x)
traits2l <- aggregate(traits$value, by = traits[,c(1,3:5)], FUN = na.omit(length))
traits2l <- rename(traits2l, n_obs = x)
traits2sd <- aggregate(traits$value, by = traits[,c(1,3:5)], FUN = na.omit(var)) # defaults to sample not population variance
traits2sd$x <- sqrt(traits2sd$x)
traits2sd <- rename(traits2sd, sd = x)

traits3 <- cbind(traits2, traits2l$n_obs, traits2sd$sd)
traits3 <- rename(traits3, n_obs = `traits2l$n_obs`, sd = `traits2sd$sd`)
traits3$ID <- paste(traits3$siteID, traits3$species, traits3$trait, sep = "_")
traits3C <- filter(traits3, warming == "C") # Control
traits3OTC <- filter(traits3, warming == "W") # Warming

traits3C <- traits3C %>% rename(C_mean = mean_value, C_n = n_obs, C_sd = sd) %>% select(-c(warming))
traits3OTC <- traits3OTC %>% rename(OTC_mean = mean_value, OTC_n = n_obs, OTC_sd = sd) %>%
  select(-c(siteID, species, warming, trait))

traits4 <- full_join(traits3C, traits3OTC, by = "ID")
traits4 <- select(traits4, -c(ID))
traits4 <- filter(traits4, !is.na(traits4$siteID) & !is.na(traits4$OTC_mean))
traits4 <- traits4 %>% mutate(mean_dif = C_mean - OTC_mean, n_dif = C_n - OTC_n, sd_dif = C_sd - OTC_sd)

traits4$pooled_SD <- NA
for(i in 1:nrow(traits4)) {
  traits4$pooled_SD[i] <- if(traits4$n_dif[i] == 0)
  {sqrt((traits4$C_sd[i]^2+traits4$OTC_sd[i]^2)/2)} # pooled sd for equal group sizes
  else {sqrt(((traits4$C_n[i] - 1) * traits4$C_sd[i]^2 + (traits4$OTC_n[i] - 1) * traits4$OTC_sd[i]^2) / (traits4$C_n[i] + traits4$OTC_n[i] - 2))} # pooled sd for unequal group sizes
  }

traits4$SES <- (traits4$OTC_mean - traits4$C_mean) / traits4$pooled_SD # Cohen's d: number of SDs between the two means:
 # mean(group a) - mean(group b) divided by pooled standard deviation.  https://en.wikiversity.org/wiki/Cohen%27s_d

traits4$PR <- (traits4$OTC_mean - traits4$C_mean) / traits4$C_mean # Relative Distance Plasticity Index: shows the factor by which the trait value in the OTC increased or decreased, in comparison to the control plot

rm(traits1, traits1l, traits1sd, traits2, traits2l, traits2sd, traits3, traits3C, traits3OTC, i)
```

# Task: compute p-values for the mean differences to see which are significant

# Plotting SES values
```{r}
n_obs <- traits4 %>% filter(!is.na(SES)) %>% group_by(siteID, trait) %>% mutate(n_obs = n()) %>%
                     sample_n(1) %>% select(siteID, trait, n_obs)
SES_sites <- traits4 %>% select(c(1:3,5,8,14)) %>% na.omit()
SES_sites <- aggregate(SES_sites$SES, by = SES_sites[,c(1,3)], FUN = mean)
SES_sites <- SES_sites %>% rename(`mean SES` = x)
SES_sites$trait <- case_when(SES_sites$trait == "leaf_area_cm2" ~ "LA", SES_sites$trait == "leaf_thickness_mm" ~ "LTH", SES_sites$trait == "sla_cm2_g" ~ "SLA", SES_sites$trait == "plant_height_cm" ~ "H", SES_sites$trait == "ldmc" ~ "LDMC", SES_sites$trait == "c_n" ~ "C/N", SES_sites$trait == "c_percent" ~ "C %", SES_sites$trait == "d13c" ~ "D13C", SES_sites$trait == "d15n" ~ "D15N", SES_sites$trait == "n_percent" ~ "N %")
SES_sites$level <- case_when(SES_sites$`mean SES` < 0 ~ "negative", SES_sites$`mean SES` > 0 ~ "positive")

test <- SES_sites %>% group_by(trait) %>% mutate(mean_trait = mean(`mean SES`)) %>% sample_n(1) %>% select(c(trait, mean_trait))

SES_sites$siteID <- factor(SES_sites$siteID, levels = c("Ulvehaugen", "Gudmedalen", "Skjelingahaugen"))
SES_sites$trait <- factor(SES_sites$trait, levels = c("C %", "N %", "C/N", "D13C", "D15N", "H", "LA", "LDMC", "LTH", "SLA"))

SES_plot <- ggplot(SES_sites, aes(x = siteID, y = `mean SES`, shape = level)) +  
  geom_point(size = 3) +
  scale_shape_manual(values = c(1, 16)) +
  geom_hline(yintercept = 0, lty = 2, size = 0.25) +
  coord_flip() +
  xlab("") + ylab("Absolute Cohen's d") +
  theme_bw() +
  guides(colour = "legend", shape = "none") +
  facet_grid(. ~ trait) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        legend.title = element_blank(),
        legend.position= "top",
        legend.text = element_text(size = 16),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(angle=45, vjust=.5, size = 16),
        axis.text.y = element_text(vjust=.5, size = 16),
        strip.text = element_text(size = 16, face = "bold"))

# print 1200 x 400

SES_sites$siteID <- factor(SES_sites$siteID, levels = c("Skjelingahaugen", "Gudmedalen", "Ulvehaugen"))

SES_plot2 <- ggplot(SES_sites, aes(x = siteID, y = `mean SES`, group = trait)) +
  geom_line(aes(color = trait), linewidth = 1, alpha = 0.5) +
  geom_point(aes(color = trait), size = 2) +
  theme_classic() + xlab("") + ylab("Absolute Cohen's d") +
  theme(axis.title.y = element_text(size = 14),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, face = "bold"))
# print 600 x 400
```

# Species specific plasticity and succeptibility to warming
```{r}
# Species without paired observations (inside and outside OTC) are omitted!!
distribution <- readr::read_tsv("../Input data/species classifications.txt", guess_max = Inf)
raw_traits <- readr::read_tsv("../Input data/PFTC6_Incline_clean_leaf_traits_2022.txt", guess_max = Inf)

traits_scaled <- traits %>% as.data.frame() %>% select(species, trait, value)
traits_scaled <- traits_scaled %>% semi_join(filter(traits4, !is.na(SES)), by = "species") # remove species without SES values
traits_scaled <- traits_scaled %>% group_by(trait) %>% mutate(scaled_values = scale(value, center = T, scale = T)) %>% ungroup()

species_sd <- aggregate(traits_scaled$scaled_values, by = traits_scaled[,1:2], FUN = na.omit(var))
species_sd$V1 <- sqrt(species_sd$V1)
species_sd <- rename(species_sd, sd = V1)
species_sd <- species_sd %>% group_by(species) %>% summarise(mean_sd = mean(sd, na.rm = T))

species_n <- raw_traits %>% group_by(ID) %>% select(c(species, ID)) %>% slice_sample(n = 1)
species_n <- as.data.frame(table(species_n$species))
species_n <- rename(species_n, species = Var1)

mean_abs_SES <- traits4 %>% select(species, SES) %>% na.omit() %>% mutate(SES = abs(SES)) # mean absolute SES per species
mean_abs_SES <- mean_abs_SES %>% group_by(species) %>% summarise(mean_SES = mean(SES, na.rm = T)) # susceptibility to warming

sgnf_SES <- traits4 %>% filter(SES >= 1 | SES <= -1) %>% group_by(species) %>% summarise(sgnf_SES = n())

species_sd <- species_sd %>% left_join(species_n, by = "species") %>% left_join(distribution, by = "species") %>% left_join(mean_abs_SES, by = "species") %>% left_join(sgnf_SES, by = "species")

rm(traits_scaled, species_n, distribution, raw_traits, mean_abs_SES, sgnf_SES)

```

# DEPRECTAED
```{r}
# d13c only has negative values while d15n has positive and negative values
# Somehow for d15n, values range around 0 so relative sd makes no sense as mean = 0 and sd = 1 ..
# Instead, use e.g. MAD mean absolute deviation. 1/n * sum(abs(x-mean)). That doesnt solve the problem. The problem is that traits have different units of measurement. To be able to compare variation between traits, I divide sd by mean which is not possible for d15n. Instead, scale the traits seperately (?)
# Computation of Cohen's d is not affected by values ranging around 0

species_mad <- aggregate(traits$value, by = traits[,4:5],
                         FUN = function(x) ie2misc::madstat(x))
species_sd <- aggregate(traits$value, by = traits[,4:5], FUN = na.omit(var))
species_sd$x <- sqrt(species_sd$x)
species_sd <- rename(species_sd, sd = x)
species_mean <- aggregate(traits$value, by = traits[,4:5], FUN = na.omit(mean))

species_abs_SES <- traits4 %>% na.omit() %>% group_by(species) %>% summarise(mean_SES = mean(abs(SES)))

species_sd <- cbind(species_sd, species_mean[,3])
species_sd <- rename(species_sd, mean = `species_mean[, 3]`)
species_sd <- species_sd %>% mutate(rel_sd = sd / mean) #%>% select(-c(sd, mean))


rm(species_mean, species_abs_SES)
```

# plotting relationship between trait plasticity and species type
```{r}
p1 <- ggplot(species_sd, aes(x = as.factor(alpine), y = mean_sd)) + geom_boxplot(outlier.alpha = 0) + theme_classic() +
  geom_jitter(width = 0.3, height = 0, alpha = 0.3) +
  scale_y_continuous(breaks = c(0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1), limits = c(0.4, 1)) +
  scale_x_discrete(labels = c("Generalist", "Alpine")) + xlab("") + ylab("Mean sd per species") +
  theme(axis.text.x = element_text(size = 10), axis.text.y = element_text(size = 10))
# print 350 x 400

```

# plotting relationship between susceptibility to warming and species type
```{r}
p2<- ggplot(species_sd, aes(x = as.factor(alpine), y = mean_SES)) + geom_boxplot(outlier.alpha = 0) + theme_classic() +
  geom_jitter(width = 0.3, height = 0, alpha = 0.3) +
  scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6, 0.8), limits = c(0, 1)) +
  scale_x_discrete(labels = c("Generalist", "Alpine")) + xlab("") + ylab("Mean absolute SES per species") +
  theme(axis.text.x = element_text(size = 10), axis.text.y = element_text(size = 10))
# print 350 x 400

```

# t.tests
```{r}
all_cmb <- traits %>% select(-c(blockID, warming, value)) %>% group_by(siteID, species, trait) %>%
                      slice_sample(n = 1) # all combinations of sites, species and traits

out <- list() #output is list of p-values
for(i in 1:nrow(all_cmb)){ 
  tryCatch({
  cmb <- all_cmb[i,1:3]
  subset <- filter(traits,  siteID == paste(cmb[1,1]) & species == paste(cmb[1,2]) & trait == paste(cmb[1,3]))
  t_res <- t.test(subset$value ~ subset$warming)
  out[[i]]  <- paste(t_res$p.value, i)}, error = function(e){})
} # in every iteration I filter for one species, trait and site, output is list of p-values

out <- out[lapply(out, length) > 0]
t_results <- out %>% as.data.frame() %>% t() %>% as.data.frame()
t_results <- t_results %>% separate_wider_delim(V1, delim = " ", names = c("p-value", "iteration"))

all_cmb <- all_cmb %>% rownames_to_column(var = "iteration") %>% left_join(t_results, by = "iteration")
sign_cmb <- filter(all_cmb, `p-value` < 0.05)
```